---
title: "Prueba Dashboard Lluvia-Nivel"
autor: "Jorge Moncayo"
date: "26/11/2020"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
---

```{r setup, include=FALSE}

# Carga inicial de librer√≠as

library(tidyverse)
library(ggplot2)
library(dygraphs)
library(plotly)
library(plyr)
library(xts)
library(flexdashboard)
library(urltools)
library(lubridate)
library(reshape2)
library(skimr)


# Funcion para obtener dataset de estaci√≥n limnigr√°fica

get_data_limni = function(estacion, inicio, final){
  url="https://www.piraguacorantioquia.com.co/api/nivel/1017?date_estacion__gte=2020-01-01&date_estacion__lt=2020-01-02&downloadfile"
  url2 = param_set(url, "date_estacion__gte", inicio)
  url3 = param_set(url2, "date_estacion__lt", final)
  gsub("1017", estacion, url3)
}

###############################################

# Caudales y niveles

# Carga inicial de datos

limni = read_csv(get_data_limni("1017", "2011-01-01", "2020-11-25"))

# Eliminamos filas con NA's

limni = na.omit(limni)

# Cambiando nombre a columnas de limni

colnames(limni) = c("Fecha", "Muestra", "Nivel", "Caudal")

#limni$Ano <- format(as.Date(limni$Fecha), "%Y")
#head(limni)


limni$Fechas = floor_date(limni$Fecha, "2 hours")

limni2 = limni %>%
  group_by(Fechas) %>%
  dplyr::summarise(mean_Nivel = mean(Nivel), mean_Caudal = mean(Caudal))

limni2$Ano <- format(as.Date(limni2$Fechas), "%Y")

```

Reporte de caudales y niveles
=======================================================================

Row
-----------------------------------------------------------------------

### Reporte hist√≥rico de niveles (Estaci√≥n limnigr√°fica 1017-Copacabana)

```{r}

p = ggplot(limni2, aes(x = Fechas, y = mean_Nivel)) +
  stat_smooth(color='blue') +
  geom_line(colour = "#2391D0", alpha = 0.6) +
  #geom_line(stat = "summary", fun.y = "mean", colour = "#009640") +
  labs(x = "A√±o", y = "Nivel registrado [m]")
  
ggplotly(p)

```

### Diagrama de cajas y bigotes para datos hist√≥ricos de niveles (Estaci√≥n limnigr√°fica 1017-Copacabana)

```{r}

p = ggplot(limni2) +
  geom_boxplot(mapping = aes(x = Ano, y = mean_Nivel, color = Ano)) +
  labs(x = "A√±o", y = "Nivel registrado [m]") +
  theme(legend.position = "right") +
  theme(legend.title=element_blank())
  
ggplotly(p)

```


Row
-----------------------------------------------------------------------

### Reporte hist√≥rico de caudales (Estaci√≥n limnigr√°fica 1017-Copacabana)

```{r}

p = ggplot(limni2, aes(x = Fechas, y = mean_Caudal)) +
  stat_smooth(color='blue') +
  geom_line(colour = "#2391D0", alpha = 0.6) +
  #geom_line(stat = "summary", fun.y = "mean", colour = "#009640")
  labs(x = "A√±o", y = "Caudal [m\u00b3/s]")
  
ggplotly(p)

```

### Diagrama de cajas y bigotes para datos hist√≥ricos de caudal (Estaci√≥n limnigr√°fica 1017-Copacabana)

```{r}

p = ggplot(limni2) +
  geom_boxplot(mapping = aes(x = Ano, y = mean_Caudal, color = Ano)) +
  labs(x = "A√±o", y = "Caudal [m\u00b3/s]") +
  theme(legend.position = "right") +
  theme(legend.title=element_blank())
  
ggplotly(p)

```

Reporte de lluvia y caudal semanal 
=======================================================================

**Semana 16 -23 de Noviembre de  2020**

Se evidenci√≥:

**Precipitaci√≥n** üåß:

El municipio con la estaci√≥n que presento m√°s precipitaci√≥n fue **Campamento - (Oficina Territorial Taham√≠es)** obtuvo el registro de acumulado de lluv√≠a  para la semana m√°s alto de toda la Jurisdicci√≥n para esta semana con una cantidad de **113 mm**, su promedio hist√≥rico est√° en **41 mm** obteniendo un incremento de 175 % de precipitaci√≥n bajo el valor del promedio hist√≥rico registrado.

El municipio con la estaci√≥n que present√≥ m√°s precipitaci√≥n fue **Guadalupe - (Oficina Territorial Taham√≠es)**, obtuvo el registro de acumulado de lluv√≠a m√°s alto para la semana de toda la Jurisdicci√≥n para esta semana con una cantidad de **176 mm**, su promedio hist√≥rico esta en **224 mm**, pero en esta estaci√≥n NO sobrepaso el promedio historico semanal de este a√±o.

En general, en la Jurisdicci√≥n llovi√≥ en promedio **42 mm** respecto a los **36 mm** registrados el a√±o pasado, lo cual significa un incremento del 18%.


**Caudal** „Ä∞ :

El resumen del comporatamiento de los principales puntos de medici√≥n de caudal de la Jurisdicci√≥n con variaciones entre su registro actual y el promedio hist√≥rico

<https://drive.google.com/file/d/1_lThWM2B5iJp41jwAU1AHXIuwjAJBn6_/view?usp=sharing>

**Monitoreo de Calidad**  üíß:

Se realizaron: 40 monitoreos en la jurisdicci√≥n distribuidos as√≠:

Citar√°: 26 fuentes abastecedoras monitoreadas
Cartama: 3 fuentes abastecedoras monitoreadas  

Fuentes Instrumentadas: 11 ( fuente d√≥nde tenemos medici√≥n de caudal) 

